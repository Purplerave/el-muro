import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  try {
    const { memory, manual_text, manual_mode } = await req.json()
    const GROQ_KEY = Deno.env.get('GROQ_KEY')
    const SUPABASE_URL = Deno.env.get('SUPABASE_URL')
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)

    let jokeText = "";
    let cleanPrompt = "";

    // MODO MANUAL (ADMIN): Usamos el texto que nos mandas
    if (manual_mode && manual_text) {
        jokeText = manual_text;
        // Pedimos a Groq SOLO el prompt de imagen para este texto
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${GROQ_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: "llama3-8b-8192", 
                messages: [
                    { role: "system", content: "Create a very short, surrealist, artistic image description in English for this joke. Max 10 words. Output ONLY the description." },
                    { role: "user", content: manual_text }
                ],
                temperature: 0.5
            })
        });
        const data = await response.json();
        cleanPrompt = (data.choices?.[0]?.message?.content || "funny abstract art").replace(/[^a-zA-Z0-9 ]/g, "");
    
    } else {
        // MODO AUTOMÁTICO (IA): Genera chiste + prompt
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${GROQ_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: "llama3-8b-8192", 
                messages: [
                    { role: "system", content: "Eres una IA comediante. Devuelve JSON: 'joke' (chiste corto español) y 'image_prompt' (descripción visual en inglés). NO escribas nada más." },
                    { role: "user", content: "Genera un chiste nuevo. Evita: " + memory }
                ],
                temperature: 0.6,
                response_format: { type: "json_object" }
            })
        });
        const data = await response.json();
        let content = data.choices?.[0]?.message?.content || "{}";
        let parsed = {};
        try { parsed = JSON.parse(content); } catch(e) { parsed = { joke: content, image_prompt: "abstract shapes" }; }
        
        jokeText = parsed.joke || "Error IA";
        cleanPrompt = (parsed.image_prompt || "funny abstract").replace(/[^a-zA-Z0-9 ]/g, "");
    }

    // Generar Imagen
    const seed = Math.floor(Math.random() * 1000); 
    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?seed=${seed}&width=400&height=300&nologo=true`;

    // Insertar en DB
    const fakeNames = ['Bot_Picasso', 'Dali_Digital', 'IA_Comedia', 'Robo_Risitas'];
    // Si es manual, usamos un nombre especial de Admin o IA
    const authorName = manual_mode ? "Admin_Supremo" : fakeNames[Math.floor(Math.random() * fakeNames.length)];
    const authorID = manual_mode ? '11111111-1111-1111-1111-111111111111' : '00000000-0000-0000-0000-000000000000'; // ID Especial Admin

    await supabase.from('jokes').insert([{ 
        text: jokeText, 
        author: authorName, 
        authorid: authorID, 
        color: manual_mode ? "#e0f7fa" : "#e1bee7", 
        avatar: manual_mode ? "bot6" : ('bot' + (Math.floor(Math.random() * 6) + 1)),
        image_url: imageUrl
    }]);

    return new Response(JSON.stringify({ success: true, text: jokeText }), { 
      headers: { ...corsHeaders, "Content-Type": "application/json" } 
    })

  } catch (err) {
    return new Response(JSON.stringify({ error: err.message }), { 
      status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } 
    })
  }
})