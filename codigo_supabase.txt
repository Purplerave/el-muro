import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

Deno.serve(async (req) => {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  }

  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  try {
    const body = await req.json().catch(() => ({}))
    const { memory, manual_text, manual_mode } = body

    const SUPABASE_URL = Deno.env.get('SUPABASE_URL')
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    const GROQ_KEY = Deno.env.get('GROQ_KEY')

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
    
    let jokeText = ""

    if (manual_mode && manual_text) {
        jokeText = manual_text
    } else {
        const groqRes = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${GROQ_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: "mixtral-8x7b-32768",
                messages: [
                    { role: "system", content: "Eres una IA comediante espa침ola. Genera un chiste corto (m치ximo 15 palabras). Humor absurdo, ir칩nico o cl치sico." },
                    { role: "user", content: "Dime un chiste nuevo que no sea: " + (memory || "") }
                ],
                temperature: 0.7
            })
        })
        const groqData = await groqRes.json()
        jokeText = groqData.choices?.[0]?.message?.content?.trim().replace(/^"|"$/g, '') || "Error generando chiste"
    }

    // Insertar en DB (Marcamos los de IA con un color especial para el CSS nuevo)
    await supabase.from('jokes').insert([{
        text: jokeText,
        author: manual_mode ? "Admin_Supremo" : "Bot_IA",
        authorid: manual_mode ? '11111111-1111-1111-1111-111111111111' : '00000000-0000-0000-0000-000000000000',
        avatar: manual_mode ? 'bot6' : ('bot' + (Math.floor(Math.random() * 6) + 1)),
        color: manual_mode ? 'special-vip' : (Math.random() > 0.8 ? 'special-ai' : '#fff9c4')
    }])

    return new Response(JSON.stringify({ success: true }), { headers: corsHeaders })

  } catch (err) {
    return new Response(JSON.stringify({ error: err.message }), { status: 200, headers: corsHeaders })
  }
})