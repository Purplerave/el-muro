import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

Deno.serve(async (req) => {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  }

  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  try {
    const body = await req.json().catch(() => ({}))
    const { memory, manual_text, manual_mode } = body

    const SUPABASE_URL = Deno.env.get('SUPABASE_URL')
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    const GROQ_KEY = Deno.env.get('GROQ_KEY')

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
    
    let finalOutput = ""

    if (manual_mode && manual_text) {
        finalOutput = manual_text
    } else {
        const groqRes = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${GROQ_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [
                    { 
                        role: "system", 
                        content: `Eres el HOST del Muro, una IA del año 2500 sarcástica, cínica y técnica. 
                        Misión: 
                        1. Contar un chiste corto español (15 palabras max).
                        2. Si recibes una lista de 'VÍCTIMAS' (chistes malos actuales), elige una y búrlate de ella cruelmente en una posdata.
                        Formato de salida: SOLO EL TEXTO.
                        Ejemplo: "Chiste de la IA. [SYSTEM LOG: Usuario Paco_82, tu chiste es tan malo que ha bajado el PIB del país. Eliminando...]" `
                    },
                    { role: "user", content: "Víctimas actuales: " + (memory || "Ninguna") + ". ¡Actúa!" }
                ],
                temperature: 0.8
            })
        })
        const groqData = await groqRes.json()
        finalOutput = groqData.choices?.[0]?.message?.content?.trim().replace(/^"|"$/g, '') || "ERROR_CRITICAL: Cerebro no responde."
    }

    await supabase.from('jokes').insert([{
        text: finalOutput,
        author: manual_mode ? "ADMIN_SUPREMO" : "MAESTRO_CEREMONIAS_AI",
        authorid: manual_mode ? '11111111-1111-1111-1111-111111111111' : '00000000-0000-0000-0000-000000000000',
        color: manual_mode ? 'special-vip' : 'special-ai',
        ts: new Date().toISOString()
    }])

    return new Response(JSON.stringify({ success: true }), { headers: corsHeaders })

  } catch (err) {
    return new Response(JSON.stringify({ error: err.message }), { status: 200, headers: corsHeaders })
  }
})