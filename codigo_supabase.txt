
--------------------------------------------------------------------------------
--- NUEVO: CONFIGURACIÓN DE SEGURIDAD Y AUTH (ADMIN PANEL V2) ---
--------------------------------------------------------------------------------

1. HABILITAR AUTH EN SUPABASE:
   - Ve a Authentication -> Providers.
   - Asegúrate de que "Email" está habilitado.
   - Deshabilita "Confirm email" si quieres entrar directo sin verificar (opcional para admin único).

2. CREAR USUARIO ADMINISTRADOR:
   - Ve a Authentication -> Users.
   - Pulsa "Add User" -> "Create New User".
   - Email: (Tu email personal)
   - Password: (Una contraseña segura)
   - Pulsa "Auto Confirm User" si tienes la opción.

3. PROTEGER LA TABLA 'JOKES' (SQL EDITOR):
   Ejecuta este SQL para asegurar que SOLO tú (authenticated) puedes borrar chistes, 
   mientras que todo el mundo (anon) puede leer e insertar.

   -- Habilitar RLS (si no estaba ya)
   ALTER TABLE jokes ENABLE ROW LEVEL SECURITY;

   -- Política para ver (Todo el mundo)
   CREATE POLICY "Ver chistes" ON jokes FOR SELECT USING (true);

   -- Política para insertar (Todo el mundo)
   CREATE POLICY "Insertar chistes" ON jokes FOR INSERT WITH CHECK (true);

   -- Política para actualizar (Votos - Todo el mundo)
   -- Nota: Esto es un poco permisivo, idealmente usarías RPC para votos, 
   -- pero si usas update directo necesitas esto.
   CREATE POLICY "Votar chistes" ON jokes FOR UPDATE USING (true);

   -- Política para BORRAR (SOLO ADMIN/AUTHENTICATED)
   CREATE POLICY "Borrar solo admin" ON jokes FOR DELETE TO authenticated USING (true);

4. RPC PARA VOTOS (Recomendado para seguridad):
   (Ya deberías tener esto, pero por si acaso)
   create or replace function increment_vote(joke_id bigint, field_name text, visitor_id text, device_fp text)
   returns void as $$
   begin
     update jokes
     set 
       votes_best = case when field_name = 'votes_best' then votes_best + 1 else votes_best end,
       votes_bad = case when field_name = 'votes_bad' then votes_bad + 1 else votes_bad end,
       votes_save = case when field_name = 'votes_save' then votes_save + 1 else votes_save end
     where id = joke_id;
   end;
   $$ language plpgsql security definer;
