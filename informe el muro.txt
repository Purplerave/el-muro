<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <title>EL MURO | Chistes Malos AI</title>
    
    <!-- Metadatos para Redes Sociales (SEO/Viral) -->
    <meta property="og:title" content="EL MURO DE LOS CHISTES MALOS üß±">
    <meta property="og:description" content="La comunidad de los peores chistes de internet. ¬øPodr√°s sobrevivir a la Purga?">
    <meta property="og:image" content="https://purplerave.github.io/el-muro/assets/preview.png">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="stylesheet" href="css/style.css?v=3.7">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Permanent+Marker&family=Kalam:wght@400;700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
</head>
<body>

    <div id="toast-container"></div>
    
    <header class="main-header">
        <div class="header-inner">
            <div class="header-top-row">
                <h1 id="title-sign">
                    <span class="top-line">EL MURO DE LOS</span>
                    <span class="bot-line">CHISTES MALOS</span>
                </h1>
                
                <div class="header-controls">
                    <input type="text" id="search-input" placeholder="üîç Buscar..." class="search-bar">
                    <button id="mute-btn" class="icon-btn">üîä</button>
                    <button id="mobile-dash-toggle" class="icon-btn mobile-only">üèÜ</button>
                </div>
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" data-sort="new">NUEVOS</button>
                <button class="filter-btn" data-sort="best">TOP üî•</button>
                <button class="filter-btn" data-sort="controversial">üíÄ PURGA</button>
            </div>
        </div>
    </header>

    <div id="main-layout">
        <main id="mural-wrapper">
            <div id="mural" class="auto-grid"></div>
        </main>

        <aside id="dashboard" aria-hidden="true">
            <button id="close-dash-btn" class="icon-btn mobile-only" style="position:absolute; top:15px; right:15px; z-index:1001; background:rgba(255,255,255,0.1); border-radius:50%;">‚úï</button>
            <div class="dashboard-content">
                <div class="dash-section danger-zone">
                    <h3>üíÄ ZONA DE PELIGRO</h3>
                    <div id="purgatory-status"></div>
                    <ul id="purgatory-list" class="rank-list"></ul>
                </div>

                <div class="dash-section">
                    <h3>üèÜ HALL OF FAME</h3>
                    <ul id="humorists-list" class="rank-list"></ul>
                </div>
            </div>
        </aside>
    </div>

    <footer id="input-bar">
        <div class="input-linear-container">
            <div class="row-1-mobile">
                <div class="user-badge" id="my-badge">
                    <div class="avatar-slot">
                        <img id="my-avatar-img" src="" alt="Avatar">
                    </div>
                    <input type="text" id="user-alias" placeholder="TU ALIAS" maxlength="12">
                </div>

                <div class="color-picker">
                    <button class="dot active" style="--c:#FFEB3B" data-color="#FFEB3B"></button>
                    <button class="dot" style="--c:#FF4081" data-color="#FF4081"></button>
                    <button class="dot" style="--c:#00E676" data-color="#00E676"></button>
                    <button class="dot" style="--c:#2979FF" data-color="#2979FF"></button>
                </div>
            </div>

            <div class="row-2-mobile">
                <div class="input-main">
                    <input type="text" id="secret-input" placeholder="¬°Suelta tu peor chiste...!" maxlength="300">
                    <span id="char-counter">0/300</span>
                </div>
                <button id="post-btn" class="send-btn">PEGAR</button>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/script.js?v=13.0"></script>
</body>
</html>


---------------------

CSS:

:root {
    --bg-dark: #121212;
    --accent: #FFEB3B;
    --accent-sec: #FF00FF;
    --text-main: #ffffff;
    --font-head: 'Bangers', cursive;
    --font-hand: 'Kalam', cursive;
    --header-h: 100px;
    --footer-h: 80px;
}

body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

/* --- HEADER DESKTOP --- */
.main-header { height: var(--header-h); position: fixed; top: 0; width: 100%; z-index: 500; background: #121212; display: flex; align-items: center; border-bottom: 2px solid #222; }
.header-inner { width: 100%; max-width: 1400px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; margin: 0 auto; }
.header-top-row { display: contents; }

#title-sign { display: flex; flex-direction: column; line-height: 0.8; filter: drop-shadow(3px 3px 0 #000); cursor: pointer; }
.bot-line { font-family: 'Bangers'; font-size: 3rem; color: var(--accent); -webkit-text-stroke: 1px black; text-shadow: 3px 3px 0px var(--accent-sec); }

.header-controls { display: flex; gap: 15px; align-items: center; }
.search-bar { background: #222; border: 1px solid #444; color: #fff; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; width: 200px; outline: none; transition: 0.3s; }
.search-bar:focus { border-color: var(--accent); width: 250px; }

.filter-bar { display: flex; gap: 8px; background: #000; padding: 3px; border: 1px solid #333; }
.filter-btn { background: transparent; border: none; color: #888; padding: 8px 15px; font-weight: 900; cursor: pointer; font-size: 0.9rem; }
.filter-btn.active { background: var(--accent); color: #000; }

.icon-btn { background: #000; border: 1px solid #333; color: #fff; width: 44px; height: 44px; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

/* --- MURAL DESKTOP --- */
#main-layout { display: flex; flex: 1; padding-top: var(--header-h); padding-bottom: var(--footer-h); }
#mural-wrapper { flex: 1; padding: 25px; }
.auto-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; padding-bottom: 50px; }

.post-it { background: var(--bg-c); color: #000; padding: 20px; border: 2px solid #000; font-family: var(--font-hand); font-size: 1.2rem; box-shadow: 8px 8px 0 #000; position: relative; }
.post-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border-top: 1px dashed rgba(0,0,0,0.2); padding-top: 10px; }
.author-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: bold; }
.author-info img { width: 24px !important; height: 24px !important; border-radius: 50%; border: 1px solid #000; background: #fff; flex-shrink: 0; }

.actions { display: flex; gap: 8px; }
.act-btn { background: #fff; border: 2px solid #000; padding: 5px 10px; border-radius: 4px; font-weight: 900; cursor: pointer; transition: 0.1s; }
.act-btn:hover { transform: translate(-2px, -2px); box-shadow: 2px 2px 0 #000; }

/* --- INPUT BAR DESKTOP --- */
#input-bar { position: fixed; bottom: 0; width: 100%; height: var(--footer-h); background: #111; border-top: 4px solid var(--accent); z-index: 600; display: flex; align-items: center; }
.input-linear-container { display: flex; flex-direction: row !important; gap: 20px; width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 20px; align-items: center; }

.row-1-mobile, .row-2-mobile { display: contents; }

.user-badge { display: flex; align-items: center; background: #222; padding: 8px 15px; border: 1px solid #444; border-radius: 5px; }
.avatar-slot { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #000; background: #fff; overflow: hidden; margin-right: 12px; }
#user-alias { background: transparent; border: none; color: var(--accent); width: 120px; outline: none; font-weight: bold; font-size: 1.1rem; }

.color-picker { display: flex; gap: 10px; }
.dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #000; background: var(--c); cursor: pointer; transition: 0.2s; }
.dot.active { transform: scale(1.3); border-color: #fff; }

.input-main { flex: 1; position: relative; }
#secret-input { width: 100%; height: 50px; background: #fff; border: 3px solid #000; padding: 0 15px; font-family: var(--font-hand); font-size: 1.3rem; border-radius: 5px; outline: none; }
#char-counter { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; color: #666; font-weight: bold; }

.send-btn { background: var(--accent-sec); color: #fff; border: 3px solid #000; padding: 0 30px; height: 50px; font-family: 'Bangers'; font-size: 1.6rem; cursor: pointer; box-shadow: 4px 4px 0 #000; }

/* --- DASHBOARD DESKTOP --- */
#dashboard { width: 350px; background: #1a1a1a; border-left: 3px solid #000; overflow-y: auto; display: flex; flex-direction: column; }
.dashboard-content { padding: 25px; }
.dash-section h3 { color: var(--accent); font-family: 'Bangers'; font-size: 1.5rem; border-bottom: 2px solid #333; margin-bottom: 20px; }
.rank-list li { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px dashed #333; }

/* --- MOBILE OVERRIDES --- */
@media (max-width: 1024px) {
    :root { --header-h: 140px; }
    
    html { overflow-x: hidden; height: auto; }

    body { 
        display: block !important; 
        min-height: auto !important; 
        overflow-y: auto !important;
        height: auto !important;
        -webkit-overflow-scrolling: touch;
    }

    .main-header { 
        height: var(--header-h); 
        position: sticky; 
        top: 0; 
        align-items: flex-start;
        z-index: 1000;
        background: #121212;
    }
    
    .header-inner { flex-direction: column; gap: 10px; }
    .header-top-row { display: flex !important; width: 100%; justify-content: space-between; align-items: center; }
    #title-sign .bot-line { font-size: 1.8rem; }
    .search-bar { display: none; }
    .filter-bar { width: 100%; justify-content: space-around; }

    #main-layout { 
        display: block !important; 
        padding-top: 10px; 
        padding-bottom: 220px; 
        overflow: visible !important; 
        height: auto !important;
        min-height: calc(100vh - var(--header-h) - var(--footer-h));
        -webkit-overflow-scrolling: touch;
    }

    #mural-wrapper { 
        padding: 15px; 
        overflow: visible !important; 
        display: block !important;
        height: auto !important;
    }

    .auto-grid { 
        display: block !important; 
    }
    
    .post-it {
        margin-bottom: 25px; 
        display: block;
    }

    #dashboard { 
        position: fixed; right: -100%; top: 0; bottom: 0; width: 100%; z-index: 2000; 
        transform: translateX(100%); transition: 0.4s; pointer-events: none;
        background: rgba(18, 18, 18, 0.98); /* M√°s opaco para que se vea bien */
    }
    #dashboard[aria-hidden="false"] { transform: translateX(0); pointer-events: auto; right: 0; }

    #input-bar { 
        height: auto; 
        padding: 15px 0; 
        position: fixed; 
        bottom: 0; 
        background: #111; 
        z-index: 1500;
    }
    .input-linear-container { flex-direction: column !important; gap: 10px; }
    .row-1-mobile { display: flex !important; width: 100%; justify-content: space-between; }
    .row-2-mobile { display: flex !important; width: 100%; gap: 10px; padding: 0 10px; }
    #secret-input { font-size: 1.1rem; }
    #char-counter { display: none; }
}

.toast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 3000; background: #000; color: #fff; padding: 15px 30px; border: 3px solid var(--accent); border-radius: 8px; font-weight: 900; text-align: center; }


SCRIPT.JS


/**
 * EL MURO V13.8 - REPARACI√ìN FINAL EMOJIS Y CARGA
 */

var SUPABASE_URL = 'https://vqdzidtiyqsuxnlaztmf.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxZHppZHRpeXFzdXhubGF6dG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyODIxNTIsImV4cCI6MjA4Mjg1ODE1Mn0.ZmDwXQ_5Rg6mTBM8JS4eDYQoBvH9ceQmHL-ELKqdWVA';

var CONFIG = {
    USER_KEY: 'elMuro_v6_usr',
    STORAGE_KEY: 'elMuro_v6_db',
    AI_NAME: '00000000-0000-0000-0000-000000000000'
};

var client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

window.app = {
    state: { jokes: [], sort: 'new' },
    displayOrder: [],
    user: null,
    isAdmin: false,
    adminClicks: 0,
    isMuted: false,
    sounds: {
        post: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
        laugh: new Audio('https://assets.mixkit.co/active_storage/sfx/2802/2802-preview.mp3'),
        splat: new Audio('https://assets.mixkit.co/active_storage/sfx/2747/2747-preview.mp3'),
        click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3')
    },
    dom: {}
};

function playSfx(name) {
    if (app.isMuted) return;
    var s = app.sounds[name];
    if (s) {
        s.currentTime = 0;
        s.play().catch(function(e) { console.warn("Audio bloqueado:", e); });
    }
}

function genUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = (c == 'x' ? r : (r & 0x3 | 0x8));
        return v.toString(16);
    });
}

function loadUser() {
    var u;
    try { u = JSON.parse(localStorage.getItem(CONFIG.USER_KEY)); } catch(e) { u = null; }
    if (!u || !u.id) {
        u = { id: genUUID(), voted: [], owned: [], alias: '', hasSaved: false };
        localStorage.setItem(CONFIG.USER_KEY, JSON.stringify(u));
    }
    console.log("Usuario cargado:", u.id);
    return u;
}

function cacheDOM() {
    app.dom = {
        mural: document.getElementById('mural'),
        input: document.getElementById('secret-input'),
        alias: document.getElementById('user-alias'),
        filters: document.querySelectorAll('.filter-btn'),
        avatarImg: document.getElementById('my-avatar-img'),
        purgList: document.getElementById('purgatory-list'),
        humorList: document.getElementById('humorists-list'),
        title: document.getElementById('title-sign'),
        muteBtn: document.getElementById('mute-btn'),
        dashToggle: document.getElementById('mobile-dash-toggle'),
        dashboard: document.getElementById('dashboard'),
        postBtn: document.getElementById('post-btn'),
        searchInput: document.getElementById('search-input'),
        charCounter: document.getElementById('char-counter'),
        closeDash: document.getElementById('close-dash-btn')
    };
    if(app.user.alias) app.dom.alias.value = app.user.alias;
}

async function initGlobalSync() {
    console.log("Intentando conectar con Supabase...");
    try {
        const res = await client.from('jokes').select('*').order('ts', { ascending: false }).limit(200);
        if (res.data) {
            console.log("Datos recibidos:", res.data.length);
            app.state.jokes = res.data;
            if (new Date().getDate() === 1) executePurge();
            freezeOrder();
            syncWall();
            checkDailyAIJoke();
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(res.data));
        } else {
            console.error("No hay datos o error:", res.error);
        }
    } catch (e) {
        console.error("Excepcion en sync:", e);
    }

    client.channel('public:jokes').on('postgres_changes', { event: '*', schema: 'public', table: 'jokes' }, function(payload) {
        handleRealtime(payload);
    }).subscribe();
}

function freezeOrder() {
    var list = app.state.jokes.slice();
    if (app.state.sort === 'best') {
        app.displayOrder = list.sort(function(a,b) { return (b.votes_best || 0) - (a.votes_best || 0); });
    } else if (app.state.sort === 'controversial') {
        app.displayOrder = list.filter(function(j) {
            return (j.votes_bad || 0) > (j.votes_best || 0);
        }).sort(function(a,b) { return (b.votes_bad - b.votes_best) - (a.votes_bad - a.votes_best); }).slice(0, 3);
    } else {
        app.displayOrder = list.sort(function(a,b) { return new Date(b.ts) - new Date(a.ts); });
    }
}

function handleRealtime(payload) {
    if (payload.eventType === 'UPDATE') {
        var idx = app.state.jokes.findIndex(function(j) { return j.id === payload.new.id; });
        if (idx !== -1) app.state.jokes[idx] = payload.new;
        updateCardUI(payload.new);
        updateStats();
    } else if (payload.eventType === 'INSERT') {
        showToast('Nuevos chistes! Refresca.');
    }
}

function updateCardUI(joke) {
    var card = document.getElementById('joke-' + joke.id);
    if (card) {
        var spans = card.querySelectorAll('.actions span');
        if(spans[0]) spans[0].innerText = joke.votes_best || 0;
        if(spans[1]) spans[1].innerText = joke.votes_bad || 0;
    }
}

function syncWall() {
    var container = app.dom.mural;
    if(!container) return;
    container.innerHTML = '';
    
    if (app.state.sort === 'controversial') {
        var days = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() - new Date().getDate();
        var info = document.createElement('div');
        info.style.cssText = "grid-column:1/-1; background:#1a1a1a; border:2px dashed #ff1744; padding:20px; text-align:center; margin-bottom:20px;";
        info.innerHTML = '<h2 style="font-family:Bangers; color:#ff1744; font-size:2rem;">üíÄ MODO PURGA</h2><p style="color:#aaa;">D√≠as para el juicio: '+days+'</p>';
        container.appendChild(info);
    }

    if (app.displayOrder.length === 0) {
        container.innerHTML += '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#aaa;"><h2 style="font-family:Bangers; font-size:3rem; color:var(--accent);">VAC√çO...</h2></div>';
    } else {
        for (var i=0; i<app.displayOrder.length; i++) {
            container.appendChild(createCard(app.displayOrder[i]));
        }
    }
    updateStats();
}

function createCard(joke) {
    var el = document.createElement('article');
    el.className = 'post-it';
    el.id = 'joke-' + joke.id;
    el.style.setProperty('--bg-c', joke.color || '#FFEB3B');
    el.style.setProperty('--rot', (joke.rot || 0) + 'deg');
    
    var isVoted = app.user.voted.indexOf(joke.id) !== -1;
    var vClass = isVoted ? 'voted' : '';
    var adminBtn = app.isAdmin ? '<button class="act-btn del-btn" data-id="' + joke.id + '" style="background:#ff1744; color:#fff;">üóëÔ∏è</button>' : '';
    var authorImg = 'https://api.dicebear.com/7.x/bottts/svg?seed=' + (joke.authorid || joke.author);

    el.innerHTML = '<div class="post-body">' + sanitize(joke.text) + '</div>' +
        '<div class="post-footer">' +
            '<div class="author-info">' +
                '<img src="' + authorImg + '" width="24" height="24" style="width:24px!important;height:24px!important;border-radius:50%;border:1px solid #000;background:#fff;flex-shrink:0;">' +
                sanitize(joke.author) +
            '</div>' +
            '<div class="actions">' +
                adminBtn +
                '<button class="act-btn vote-btn ' + vClass + '" data-id="' + joke.id + '" data-type="best">ü§£ <span>' + (joke.votes_best || 0) + '</span></button>' +
                '<button class="act-btn vote-btn ' + vClass + '" data-id="' + joke.id + '" data-type="bad">üçÖ <span>' + (joke.votes_bad || 0) + '</span></button>' +
                '<button class="act-btn share-btn" data-id="' + joke.id + '">‚ÜóÔ∏è</button>' +
            '</div>' +
        '</div>';
    return el;
}

function initDelegation() {
    app.dom.mural.addEventListener('click', function(e) {
        var btn = e.target.closest('.act-btn');
        if (!btn) return;
        var id = btn.dataset.id;
        if (btn.classList.contains('vote-btn')) vote(id, btn.dataset.type);
        if (btn.classList.contains('share-btn')) shareJoke(id);
        if (btn.classList.contains('del-btn')) deleteJoke(id);
    });
}

async function vote(id, type) {
    if (app.user.voted.indexOf(id) !== -1) return showToast('Ya has votado');
    if (app.user.owned.indexOf(id) !== -1) return showToast('Es tu chiste');
    
    // Sonido inmediato para feedback t√°ctil
    playSfx(type === 'best' ? 'laugh' : 'splat');

    var joke = app.state.jokes.find(function(j) { return j.id === id; });
    var field = type === 'best' ? 'votes_best' : 'votes_bad';
    try {
        const res = await client.from('jokes').update({ [field]: (joke[field] || 0) + 1 }).eq('id', id);
        if (!res.error) { 
            app.user.voted.push(id);
            localStorage.setItem(CONFIG.USER_KEY, JSON.stringify(app.user)); 
            refreshData(); 
        }
    } catch(e) {}
}

async function postJoke() {
    var text = app.dom.input.value.trim();
    var alias = app.dom.alias.value.trim();
    if (!alias || text.length < 3) return showToast('Escribe algo...');
    app.dom.postBtn.disabled = true;
    try {
        var dot = document.querySelector('.dot.active');
        var color = dot ? dot.dataset.color : '#FFEB3B';
        const res = await client.from('jokes').insert([{ text: text, author: alias, authorid: app.user.id, color: color, rot: 1, votes_best: 0, votes_bad: 0 }]).select();
        if (!res.error) { 
            playSfx('post');
            app.dom.input.value = ''; 
            app.user.owned.push(res.data[0].id); 
            localStorage.setItem(CONFIG.USER_KEY, JSON.stringify(app.user)); 
            refreshData(); 
            showToast('Pegado!'); 
        }
    } catch(e) {}
    app.dom.postBtn.disabled = false;
}

function searchJokes(term) {
    var t = term.toLowerCase();
    document.querySelectorAll('.post-it').forEach(function(card) {
        var content = card.querySelector('.post-body').textContent.toLowerCase();
        card.style.display = content.indexOf(t) !== -1 ? 'block' : 'none';
    });
}

function showToast(m) {
    var t = document.createElement('div'); t.className = 'toast show'; t.innerText = m;
    var c = document.getElementById('toast-container');
    if(c) { c.appendChild(t); setTimeout(function() { if(t.parentNode) t.remove(); }, 2500); }
}

function sanitize(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function isPurgeActive() {
    var now = new Date();
    var lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    return (lastDay - now.getDate()) <= 3;
}

window.onload = function() {
    console.log("Iniciando EL MURO V13.8...");
    app.user = loadUser();
    cacheDOM();
    initDelegation();
    app.dom.postBtn.onclick = postJoke;
    app.dom.input.oninput = function(e) { app.dom.charCounter.innerText = e.target.value.length + '/300'; };
    app.dom.searchInput.oninput = function(e) { searchJokes(e.target.value); };
    app.dom.filters.forEach(function(btn) {
        btn.onclick = function() {
            playSfx('click');
            app.dom.filters.forEach(function(f) { f.classList.remove('active'); });
            btn.classList.add('active');
            app.state.sort = btn.dataset.sort;
            freezeOrder();
            syncWall();
        };
    });
    app.dom.muteBtn.onclick = function() { app.isMuted = !app.isMuted; app.dom.muteBtn.innerText = app.isMuted ? 'üîá' : 'üîä'; };
    app.dom.dashToggle.onclick = function() {
        playSfx('click');
        var isH = app.dom.dashboard.getAttribute('aria-hidden') === 'true';
        app.dom.dashboard.setAttribute('aria-hidden', !isH);
        app.dom.dashToggle.innerText = isH ? '‚úï' : 'üèÜ';
    };
    if(app.dom.closeDash) {
        app.dom.closeDash.onclick = function() {
            app.dom.dashboard.setAttribute('aria-hidden', 'true');
            app.dom.dashToggle.innerText = 'üèÜ';
        };
    }
    if(app.dom.avatarImg) app.dom.avatarImg.src = 'https://api.dicebear.com/7.x/bottts/svg?seed=' + app.user.id;
    initGlobalSync();
};

async function executePurge() {
    var targets = app.state.jokes.filter(function(j) { return (j.votes_bad || 0) > (j.votes_best || 0); }).slice(0, 3);
    for (var i=0; i<targets.length; i++) await client.from('jokes').delete().eq('id', targets[i].id);
}

async function checkDailyAIJoke() {
    var lastAI = app.state.jokes.filter(function(j) { return j.authorid === CONFIG.AI_NAME; })[0];
    if (!lastAI || (Date.now() - new Date(lastAI.ts).getTime() >= 21600000)) {
        try {
            const res = await client.functions.invoke('generate-joke', { body: { memory: "" } });
            if (res.data && res.data.joke) await client.from('jokes').insert([{ text: res.data.joke, author: "Bot", authorid: CONFIG.AI_NAME, color: "#FFEB3B", rot: 1, votes_best: 0, votes_bad: 0 }]);
        } catch(e) {}
    }
}

function updateStats() {
    var worst = app.state.jokes.filter(function(j) { return (j.votes_bad || 0) > (j.votes_best || 0); }).slice(0, 3);
    if (app.dom.purgList) app.dom.purgList.innerHTML = worst.map(function(j) { return '<li><img src="https://api.dicebear.com/7.x/bottts/svg?seed=' + (j.authorid || j.author) + '" style="width:20px;height:20px;border-radius:50%;margin-right:10px;"> <span>' + j.author + '</span> <span style="color:#ff1744">üçÖ ' + j.votes_bad + '</span></li>'; }).join('') || '<li>Libre</li>';
    var best = app.state.jokes.slice().sort(function(a,b) { return (b.votes_best || 0) - (a.votes_best || 0); }).slice(0, 5);
    if (app.dom.humorList) app.dom.humorList.innerHTML = best.map(function(j) { return '<li><img src="https://api.dicebear.com/7.x/bottts/svg?seed=' + (j.authorid || j.author) + '" style="width:20px;height:20px;border-radius:50%;margin-right:10px;"> <span>' + j.author + '</span> <span style="color:var(--accent)">ü§£ ' + (j.votes_best || 0) + '</span></li>'; }).join('');
}

async function deleteJoke(id) { if (confirm('Borrar?')) { await client.from('jokes').delete().eq('id', id); refreshData(); } }
async function shareJoke(id) {
    var joke = app.state.jokes.find(function(j) { return j.id === id; });
    var txt = '"' + joke.text + '" - en EL MURO';
    if (navigator.share) await navigator.share({ title: 'EL MURO', text: txt, url: window.location.href });
    else window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(txt));
}